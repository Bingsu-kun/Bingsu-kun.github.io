<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Nginx Load Balancer | HEPHAI's devlog</title><meta name="author" content="Hephai (JangHoon Lee)"><meta name="description" content="Mainly about coding, also my hobbys."><meta property="og:title" content="Nginx Load Balancer | HEPHAI's devlog"><meta property="og:url" content="http://localhost:4000/2021/04/01/Nginx-(Load-Balancer)/"><meta property="og:site_name" content="HEPHAI's devlog"><meta property="og:description" content="Mainly about coding, also my hobbys."><meta property="og:image" content="https://res.cloudinary.com/danhdvla9/image/upload/v1617008667/Thumbnails/jenkins_vhzpmh.png"><meta property="og:type" content="blog"><meta name="twitter:card" content="summary"><meta name="twitter:description" content="Mainly about coding, also my hobbys."><meta name="twitter:title" content="Nginx Load Balancer | HEPHAI's devlog"><meta name="twitter:url" content="http://localhost:4000/2021/04/01/Nginx-(Load-Balancer)/"><meta name="twitter:site" content="HEPHAI's devlog"><meta name="twitter:creator" content="@"><meta name="twitter:domain" content="http://localhost:4000"><meta property="twitter:image" content="https://res.cloudinary.com/danhdvla9/image/upload/v1617008667/Thumbnails/jenkins_vhzpmh.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata|Lora|Space+Mono:700"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" href="/assets/css/main.css"><link rel="alternate" type="application/rss+xml" title="HEPHAI's devlog" href="http://localhost:4000/feed.xml"><link rel="canonical" href="http://localhost:4000/2021/04/01/Nginx-(Load-Balancer)/"></head><main><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><header class="section-padding--lg mast rellax" data-rellax-speed="-4"> <a class="nav nav--white" href="/"> <i class="fa fa-lg fa-arrow-left"></i> <span>Back to Posts</span> </a><figure class="absolute-bg mast__img" style="background-image: url('https://res.cloudinary.com/danhdvla9/image/upload/v1617008667/Thumbnails/jenkins_vhzpmh.png');"></figure><div class="mast__container"> <span><time datetime="2021-04-01T00:00:00+09:00" itemprop="datePublished">Apr 1, 2021</time></span><h1 itemprop="name headline">Nginx Load Balancer</h1><span>Posted in <a class="nav--white" href="/category/back-end-study">Back-End-Study</a> </span> <span></span></div></header><section class="section-padding bg-grey" itemprop="articleBody"><div class="post"><p><br /> <br /></p><h2 id="nginx-설치-및-간단-load-balancer-설정">Nginx 설치 및 간단 Load Balancer 설정</h2><p><br /> <br /></p><h4 id="nginx-란">Nginx 란?</h4><p><br /> <br /></p><p>엔진엑스(Nginx)는 Igor Sysoev라는 러시아 개발자가 동시접속 처리에 특화된 웹 서버 프로그램이다. Apache보다 동작이 단순하고, 전달자 역할만 하기 때문에 동시접속 처리에 특화되어 있다. Nginx의 역할 중 가장 중요한 두 가지 역할은 다음과 같다.</p><ul><li>정적 파일을 처리하는 HTTP 서버로서의 역할</li><li>응용프로그램 서버에 요청을 보내는 <a href="https://m.blog.naver.com/alice_k106/221190043948">리버스 프록시</a>로서의 역할</li></ul><p>또한 Nginx는 비동기 처리 방식(Event-Drive) 방식을 채택하고 있다.</p><ul><li><p>동기(Synchronous) : A가 B에게 데이터를 요청했을 때, 이 요청에 따른 응답을 주어야만 A가 다시 작업 처리가 가능 (하나의 요청, 하나의 작업에 충실)</p></li><li><p>비동기(Asynchronous) : A의 요청을 B가 즉시 주지 않아도, A의 유휴시간으로 또 다른 작업 처리가 가능한 방식</p></li></ul><p><a href="https://poiemaweb.com/js-async">동기식 처리 방식과 비동기식 처리 방식의 차이</a></p><p><br /> <br /></p><h4 id="nginx-설치">Nginx 설치</h4><p><br /> <br /></p><p><em>작성자는 Ubuntu 20.04 환경에서 실행했습니다.</em></p><p><code class="highlighter-rouge">sudo apt-get install nginx</code> 명령어로 간단하게 설치 할 수 있다.</p><p><br /> <br /></p><h4 id="nginx-실행">Nginx 실행</h4><p><br /> <br /></p><p>설치 된 상태 그대로 <code class="highlighter-rouge">sudo systemctl start nginx</code> 를 통해 Daemon을 실행해주면 바로 기본 index 페이지가 뜬다. 이 상태 그대로 웹 서버처럼 사용할 수도 있지만, Load Balacer 로써 사용하기 위해서는 <code class="highlighter-rouge">nginx.conf</code> 파일을 설정해주어야 한다. <code class="highlighter-rouge">sudo vi /etc/nginx/nginx.conf</code> 명령어를 통해 nginx의 설정을 수정하자.</p><p><strong>Load Balancing 설정을 하기 전, <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/">Nginx 공식 기술 문서</a>를 참조 할 것을 추천한다.</strong></p><p>내가 듣는 강의에서 사용한 예시 코드 :</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream cpu-bound-app {
  server {instance_1번의_ip}:8080 weight=100 max_fails=3 fail_timeout=3s;
  server {instance_2번의_ip}:8080 weight=100 max_fails=3 fail_timeout=3s;
  server {instance_3번의_ip}:8080 weight=100 max_fails=3 fail_timeout=3s;
}

location / {
  proxy_pass http://cpu-bound-app;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection 'upgrade';
  proxy_set_header Host $host;
  proxy_cache_bypass $http_upgrade;
} 

#code by foo
</code></pre></div></div><p>설정을 이렇게 바꿔주었다면 <code class="highlighter-rouge">sudo systemctl restart nginx</code> 또는 <code class="highlighter-rouge">sudo systemctl reload nginx</code>를 통해 Daemon을 재시작 해주어야 한다.</p><p><br /> <br /></p><p>여기까지하면 Nginx가 알아서 Load Balancing을 잘 해줄것 같지만 테스트해보면 그렇지가 않다. 이를 해결하기위한 과정이 아래 이어진다.</p><p><br /> <br /></p><h4 id="troubleshooting">TroubleShooting</h4><p><br /> <br /></p><p>위와 같이 설정을 마친 후, 다시 nginx에 접속해보면 404 Error 페이지가 맞이해준다. 어떤 문제점이 있었는지 확인하기 위해 nginx 서버의 log 파일을 볼 필요가 있다.</p><p><code class="highlighter-rouge">sudo tail -f /var/log/nginx/error.log;</code> 명령어를 통해 log를 열어보면, connect() 가 실패했고 에러코드 13: 권한없음 이라고 적힌 에러가 많이 나와있다. 이 에러코드를 복사해서 구글링하면 해결하기 위해 아래 명령어를 사용해야한다고 나온다.</p><p><code class="highlighter-rouge">sudo setsebool -P httpd_can_network_connect on</code></p><p>이는 connect() 메서드가 기본적으로 사용을 막아놓았기 때문에 발생하는 에러였다. 위 명령어를 실행해주고 다시 접속해보면 정상적으로 nginx가 load balancing 하고 있는 것을 확인 할 수 있다.</p></div></section><section class="profile"><div class="profile__card"><div class="profile__img"><figure class="absolute-bg" style="background-image: url('https://res.cloudinary.com/danhdvla9/image/upload/v1614694302/Blacksmith_vqd5bz.png');"></figure></div><div class="profile__container"><p>Interested in backend dev, cloud engineering, blockchain. Usually do camping, fishing, cooking, exercising on holiday. And also enjoy editing videos that I took this hobbys.</p><ul class="profile__social"><li><a class="fa fa-lg fa-envelope-o" href="mailto:icetime963@gmail.com"></a></li><li><a class="fa fa-lg fa-github" href="https://github.com/bingsu-kun" target="_blank"></a></li></ul></div></div></section></article><section class="next"> <a class="next__link" href="/2021/03/29/Jenkins/" style="background-image: url('https://res.cloudinary.com/danhdvla9/image/upload/v1617008667/Thumbnails/jenkins_vhzpmh.png');"><div class="next__container"> <span>Read Next</span><h2>Jenkins 사용 정리</h2></div></a></section></main><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rellax/1.0.0/rellax.min.js"></script> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script> <script type="text/javascript" src="/assets/js/app.js"></script></body></html>
